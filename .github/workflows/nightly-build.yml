name: Nightly Build

on:
  schedule:
    # Run every day at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  nightly-build:
    name: Nightly Build and Test
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.3
    
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1
    
    - name: Restore packages
      run: nuget restore ValidateJWT.sln
    
    - name: Build Debug
      run: msbuild ValidateJWT.sln /p:Configuration=Debug /p:Platform="Any CPU"
    
    - name: Build Release
      run: msbuild ValidateJWT.sln /p:Configuration=Release /p:Platform="Any CPU"
    
    - name: Setup VSTest
      uses: darenm/Setup-VSTest@v1.2
    
    - name: Run All Tests
      run: vstest.console.exe ValidateJWT.Tests\bin\Debug\ValidateJWT.Tests.dll /logger:trx /ResultsDirectory:TestResults
    
    - name: Upload Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: nightly-test-results
        path: TestResults/*.trx
        retention-days: 30
    
    - name: Check for Failures
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `Nightly Build Failed - ${new Date().toISOString().split('T')[0]}`,
            body: 'The nightly build has failed. Please check the workflow logs.',
            labels: ['bug', 'automated']
          });
    
    - name: Notify Success
      if: success()
      run: |
        echo "? Nightly build completed successfully"
